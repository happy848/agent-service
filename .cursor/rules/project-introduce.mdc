---
description: 
globs: 
alwaysApply: true
---
#  AI Agent Service é¡¹ç›®ä»‹ç»

## é¡¹ç›®æ¦‚è¿°
å®ç°ä¸€ä¸ªä»£ç†é‡‡è´­ç½‘ç«™çš„AIå¤§è„‘,å¯ä»¥å›å¤å®¢æˆ·çš„æ¶ˆæ¯ï¼Œå¹¶è®°å½•æ’æœŸå„ç§ä»»åŠ¡ï¼Œé…åˆä»“åº“çš„äººå‘˜å®Œæˆç½‘ç«™çš„è¿ä½œ
1. å®¢æœæ¨¡å—: å¸¸é©»ä¸€ä¸ªæµè§ˆå™¨å®šæ—¶ç›‘æµ‹ç”¨æˆ·çš„whatsappæ¶ˆæ¯,æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯åä½¿ç”¨AIå·¥å…·å®Œæˆåˆ†æå›å¤ç”¨æˆ·

### é¡¹ç›®æè¿°
æ˜¯ä¸€ä¸ªå®Œæ•´çš„AIæ™ºèƒ½ä½“æœåŠ¡å·¥å…·åŒ…ï¼ŒåŸºäºLangGraphã€FastAPI

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ¯ **LangGraphæ™ºèƒ½ä½“**: å¯å®šåˆ¶çš„æ™ºèƒ½ä½“ï¼Œæ”¯æŒLangGraph v0.3æœ€æ–°ç‰¹æ€§
- ğŸš€ **FastAPIæœåŠ¡**: æä¾›æµå¼å’Œéæµå¼ç«¯ç‚¹
- ğŸ”„ **å¤šæ™ºèƒ½ä½“æ”¯æŒ**: æ”¯æŒè¿è¡Œå¤šä¸ªæ™ºèƒ½ä½“å®ä¾‹
- âš¡ **å¼‚æ­¥è®¾è®¡**: é«˜æ•ˆå¤„ç†å¹¶å‘è¯·æ±‚
- ğŸ›¡ï¸ **å†…å®¹å®¡æ ¸**: é›†æˆLlamaGuardå†…å®¹å®¡æ ¸åŠŸèƒ½
- ğŸ“Š **åé¦ˆæœºåˆ¶**: é›†æˆLangSmithçš„è¯„åˆ†åé¦ˆç³»ç»Ÿ
- ğŸ³ **Dockeræ”¯æŒ**: å®Œæ•´çš„å®¹å™¨åŒ–è§£å†³æ–¹æ¡ˆ
- ğŸŒ **æµè§ˆå™¨è‡ªåŠ¨åŒ–**: åŸºäºPlaywrightçš„Webè‡ªåŠ¨åŒ–èƒ½åŠ›
## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç›®å½•ç»“æ„
```
â”œâ”€â”€ src/                    # ä¸»è¦æºä»£ç 
â”‚   â”œâ”€â”€ agents/            # æ™ºèƒ½ä½“å®šä¹‰
â”‚   â”œâ”€â”€ schema/            # åè®®æ¶æ„å®šä¹‰
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒæ¨¡å—ï¼ˆLLMå®šä¹‰ã€è®¾ç½®ï¼‰
â”‚   â”œâ”€â”€ service/           # FastAPIæœåŠ¡
â”‚   â”œâ”€â”€ client/            # å®¢æˆ·ç«¯äº¤äº’
â”‚   â”œâ”€â”€ memory/            # å†…å­˜ç®¡ç†
â”‚   â”œâ”€â”€ streamlit_app.py   # Streamlitåº”ç”¨
â”‚   â””â”€â”€ run_*.py           # è¿è¡Œè„šæœ¬
â”œâ”€â”€ tests/                 # å•å…ƒå’Œé›†æˆæµ‹è¯•
â”œâ”€â”€ docker/               # Dockeré…ç½®
â”œâ”€â”€ media/                # åª’ä½“èµ„æº
â””â”€â”€ .github/              # GitHubå·¥ä½œæµ
```

### æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**: FastAPI
- **æ™ºèƒ½ä½“æ¡†æ¶**: LangGraph
- **å‰ç«¯ç•Œé¢**: Streamlit  
- **æ•°æ®å¤„ç†**: Pydantic
- **æµè§ˆå™¨è‡ªåŠ¨åŒ–**: Playwright
- **æ•°æ®åº“**: PostgreSQL (å¯é€‰)
- **å®¹å™¨åŒ–**: Docker & Docker Compose
- **åŒ…ç®¡ç†**: uv

## ğŸ“‹ ç¼–ç è§„èŒƒ

### Pythonç¼–ç æ ‡å‡†

#### 1. ä»£ç é£æ ¼
- **æ ¼å¼åŒ–å·¥å…·**: Ruff (æ›¿ä»£Black + isort)
- **è¡Œé•¿åº¦**: 100å­—ç¬¦
- **Pythonç‰ˆæœ¬**: >= 3.11
- **ç±»å‹æ³¨è§£**: å¼ºåˆ¶ä½¿ç”¨ç±»å‹æç¤º

#### 2. ä»£ç è´¨é‡å·¥å…·
```yaml
# ä½¿ç”¨çš„å·¥å…·é“¾
- ruff: ä»£ç æ ¼å¼åŒ–å’Œlinting
- pre-commit: æäº¤å‰ä»£ç æ£€æŸ¥
- pytest: å•å…ƒæµ‹è¯•
- pytest-cov: æµ‹è¯•è¦†ç›–ç‡
```

#### 3. Importè§„èŒƒ
```python
# æ ‡å‡†åº“å¯¼å…¥
import os
import sys

# ç¬¬ä¸‰æ–¹åº“å¯¼å…¥
import fastapi
import langchain
from pydantic import BaseModel

# æœ¬åœ°æ¨¡å—å¯¼å…¥
from .core import settings
from .schema import types
```

#### 4. å‘½åçº¦å®š
- **æ–‡ä»¶å**: ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš” (snake_case)
- **ç±»å**: ä½¿ç”¨é©¼å³°å‘½å (PascalCase)
- **å‡½æ•°/å˜é‡å**: ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš” (snake_case)
- **å¸¸é‡**: å…¨å¤§å†™ä¸‹åˆ’çº¿åˆ†éš” (UPPER_SNAKE_CASE)

#### 5. æ–‡æ¡£è§„èŒƒ
```python
def function_example(param1: str, param2: int) -> bool:
    """
    å‡½æ•°åŠŸèƒ½çš„ç®€çŸ­æè¿°ã€‚
    
    Args:
        param1: å‚æ•°1çš„æè¿°
        param2: å‚æ•°2çš„æè¿°
        
    Returns:
        è¿”å›å€¼çš„æè¿°
        
    Raises:
        Exception: å¼‚å¸¸æƒ…å†µçš„æè¿°
    """
    pass
```

### å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ

#### 1. å¼‚æ­¥å‡½æ•°å®šä¹‰
```python
async def async_function() -> Any:
    """å¼‚æ­¥å‡½æ•°å¿…é¡»ä½¿ç”¨async/awaitæ¨¡å¼"""
    result = await some_async_operation()
    return result
```

#### 2. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†
```python
async with AsyncClient() as client:
    response = await client.get("/api/endpoint")
```

### FastAPIå¼€å‘è§„èŒƒ

#### 1. è·¯ç”±å®šä¹‰
```python
@app.post("/api/v1/resource", response_model=ResponseModel)
async def create_resource(
    request: RequestModel,
    current_user: User = Depends(get_current_user)
) -> ResponseModel:
    """RESTful APIç«¯ç‚¹å®šä¹‰"""
    pass
```

#### 2. ä¾èµ–æ³¨å…¥
```python
def get_database() -> Database:
    """ä¾èµ–æ³¨å…¥çš„æ•°æ®åº“è¿æ¥"""
    return Database()

@app.get("/users")
async def get_users(db: Database = Depends(get_database)):
    return await db.get_users()
```

### Playwrightæµè§ˆå™¨è‡ªåŠ¨åŒ–è§„èŒƒ

#### 1. åŸºç¡€é…ç½®
```python
from playwright.async_api import async_playwright, Browser, Page

class BrowserManager:
    """æµè§ˆå™¨ç®¡ç†å™¨"""
    
    def __init__(self):
        self.playwright = None
        self.browser: Browser = None
        
    async def start(self, headless: bool = True):
        """å¯åŠ¨æµè§ˆå™¨"""
        self.playwright = await async_playwright().start()
        self.browser = await self.playwright.chromium.launch(
            headless=headless,
            args=['--no-sandbox', '--disable-dev-shm-usage']
        )
        
    async def close(self):
        """å…³é—­æµè§ˆå™¨"""
        if self.browser:
            await self.browser.close()
        if self.playwright:
            await self.playwright.stop()
```
### Gitå·¥ä½œæµè§„èŒƒ

#### 1. åˆ†æ”¯å‘½å
- `feature/åŠŸèƒ½åç§°`: æ–°åŠŸèƒ½å¼€å‘
- `bugfix/é—®é¢˜æè¿°`: é—®é¢˜ä¿®å¤
- `hotfix/ç´§æ€¥ä¿®å¤`: ç´§æ€¥ä¿®å¤
- `refactor/é‡æ„å†…å®¹`: ä»£ç é‡æ„

#### 2. æäº¤ä¿¡æ¯
```
type(scope): ç®€çŸ­æè¿°

è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰

Closes #issue_number
```

ç±»å‹æ ‡è¯†:
- `feat`: æ–°åŠŸèƒ½
- `fix`: é—®é¢˜ä¿®å¤  
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼è°ƒæ•´
- `refactor`: ä»£ç é‡æ„
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»º/å·¥å…·ç›¸å…³

### ç¯å¢ƒé…ç½®è§„èŒƒ

#### 1. ç¯å¢ƒå˜é‡ç®¡ç†
```python
# ä½¿ç”¨Pydantic Settingsç®¡ç†é…ç½®
class Settings(BaseSettings):
    openai_api_key: str = Field(..., description="OpenAI APIå¯†é’¥")
    database_url: str = Field(default="sqlite:///./test.db")
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8"
    )
```

#### 2. ä¾èµ–ç®¡ç†
- ä½¿ç”¨ `uv` è¿›è¡ŒåŒ…ç®¡ç†
- `pyproject.toml` å®šä¹‰é¡¹ç›®é…ç½®
- åŒºåˆ†å¼€å‘ä¾èµ–å’Œç”Ÿäº§ä¾èµ–

#### 3. Playwrightç¯å¢ƒé…ç½®
```python
# Playwrightç›¸å…³ç¯å¢ƒå˜é‡
class PlaywrightSettings(BaseSettings):
    # æµè§ˆå™¨é…ç½®
    browser_headless: bool = Field(default=True, description="æ˜¯å¦æ— å¤´æ¨¡å¼è¿è¡Œ")
    browser_timeout: int = Field(default=30000, description="æµè§ˆå™¨æ“ä½œè¶…æ—¶æ—¶é—´(ms)")
    browser_user_agent: str = Field(default="", description="è‡ªå®šä¹‰User-Agent")
    
    # å¹³å°é…ç½®
    whatsapp_session_path: str = Field(default="./sessions/whatsapp", description="WhatsAppä¼šè¯å­˜å‚¨è·¯å¾„")
    telegram_session_path: str = Field(default="./sessions/telegram", description="Telegramä¼šè¯å­˜å‚¨è·¯å¾„")
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_prefix="PLAYWRIGHT_"
    )
```

## ğŸš€ å¼€å‘æµç¨‹

### 1. ç¯å¢ƒæ­å»º
ä½¿ç”¨dockerfile å¯åŠ¨å®¹å™¨ï¼Œå…±äº«æ–‡ä»¶åˆ°å®¹å™¨å†…è¿›è¡Œå¼€å‘

docker/Dockerfile.service
# Use the base image with all dependencies pre-installed
FROM agent-service-base:latest

WORKDIR /app

# Copy application code
COPY src/agents/ ./agents/
COPY src/core/ ./core/
COPY src/memory/ ./memory/
COPY src/schema/ ./schema/
COPY src/service/ ./service/
COPY src/run_service.py .

CMD ["python", "run_service.py"]


### æ¨¡å—å¼•ç”¨å‚è€ƒ
from agents import DEFAULT_AGENT, get_agent, get_all_agent_info
from core import settings


### æ„å»ºå®¢æœç³»ç»Ÿæ¨¡å—
1. **å¤šå¹³å°æ”¯æŒ**: é›†æˆWhatsApp
2. **æ™ºèƒ½å¯¹è¯**: ç»“åˆLangGraphæ™ºèƒ½ä½“è¿›è¡Œè‡ªåŠ¨å®¢æœå›å¤
3. **æµè§ˆå™¨è‡ªåŠ¨åŒ–**: ä½¿ç”¨Playwrightå®ç°Webç«¯èŠå¤©å¹³å°çš„è‡ªåŠ¨åŒ–æ“ä½œ
4. **æ¶ˆæ¯é˜Ÿåˆ—**: å¤„ç†é«˜å¹¶å‘çš„å®¢æœè¯·æ±‚
5. **ä¼šè¯ç®¡ç†**: ç»´æŠ¤å¤šä¸ªå®¢æˆ·çš„å¯¹è¯çŠ¶æ€

## ğŸ“š å‚è€ƒèµ„æº

- @LangGraphå®˜æ–¹æ–‡æ¡£
- [FastAPIå®˜æ–¹æ–‡æ¡£](mdc:https:/langchain-ai.github.io/langgraph)
- [Streamlitå®˜æ–¹](mdc:https:/fastapi.tiangolo.com)æ–‡æ¡£
- [Pydanticå®˜æ–¹æ–‡æ¡£](mdc:https:/streamlit.io)
- [Playwrightå®˜æ–¹](mdc:https:/docs.pydantic.dev)æ–‡æ¡£

---

*æœ€åæ›´æ–°: 2024å¹´*


